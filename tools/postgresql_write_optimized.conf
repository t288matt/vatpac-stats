# PostgreSQL Configuration for VATSIM Data Collection System
# OPTIMIZED FOR 99.9% WRITES - MINIMAL READS
# High-throughput write operations with minimal read overhead

# ===========================================
# MEMORY CONFIGURATION (Write-Optimized)
# ===========================================
shared_buffers = 512MB                    # Increased for write buffering
effective_cache_size = 2GB                 # Larger cache for write operations
work_mem = 8MB                            # Increased for bulk operations
maintenance_work_mem = 128MB              # Increased for faster maintenance
temp_buffers = 16MB                       # Increased for temporary operations

# ===========================================
# WRITE-AHEAD LOG (WAL) OPTIMIZATION
# ===========================================
wal_buffers = 32MB                        # Increased for write buffering
checkpoint_completion_target = 0.9         # Spread checkpoints over 90% of time
max_wal_size = 2GB                        # Larger WAL for fewer checkpoints
min_wal_size = 160MB                      # Increased minimum WAL size
checkpoint_timeout = 10min                # Longer between checkpoints
checkpoint_warning = 60s                  # Warn if checkpoints too frequent

# ===========================================
# WRITE PERFORMANCE SETTINGS
# ===========================================
synchronous_commit = off                  # CRITICAL: Disable sync commits for speed
fsync = on                                # Keep fsync on for data safety
wal_sync_method = fdatasync              # Fastest sync method
full_page_writes = off                    # Disable for write performance
wal_compression = on                      # Compress WAL to reduce I/O
wal_writer_delay = 200ms                  # More frequent WAL writes
commit_delay = 1000                       # Batch commits (microseconds)
commit_siblings = 5                       # Minimum concurrent transactions for batching

# ===========================================
# CONNECTION AND CONCURRENCY
# ===========================================
max_connections = 200                     # Increased for high concurrency
shared_preload_libraries = 'pg_stat_statements'

# ===========================================
# QUERY PLANNER OPTIMIZATIONS (Write-Focused)
# ===========================================
random_page_cost = 1.1                    # Optimized for SSD
effective_io_concurrency = 400            # Increased for parallel I/O
seq_page_cost = 1.0                       # Standard sequential cost
cpu_tuple_cost = 0.01                     # Standard tuple cost
cpu_index_tuple_cost = 0.005              # Standard index cost
cpu_operator_cost = 0.0025                # Standard operator cost

# ===========================================
# AUTOVACUUM (Minimal Impact on Writes)
# ===========================================
autovacuum = on                           # Keep autovacuum on
autovacuum_max_workers = 2                # Reduced workers
autovacuum_naptime = 2min                 # Less frequent autovacuum
autovacuum_vacuum_threshold = 100         # Higher threshold
autovacuum_analyze_threshold = 100        # Higher threshold
autovacuum_vacuum_scale_factor = 0.3      # Higher scale factor
autovacuum_analyze_scale_factor = 0.2     # Higher scale factor
autovacuum_vacuum_cost_limit = 2000       # Higher cost limit
autovacuum_vacuum_cost_delay = 20ms       # Shorter delay

# ===========================================
# LOGGING (Minimal for Write Performance)
# ===========================================
log_destination = stderr
logging_collector = on
log_directory = log
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
log_rotation_age = 1d
log_rotation_size = 10MB
log_min_duration_statement = 5000         # Only log slow queries (>5s)
log_checkpoints = off                      # Disable checkpoint logging
log_connections = off                      # Disable connection logging
log_disconnections = off                   # Disable disconnection logging
log_lock_waits = off                      # Disable lock wait logging
log_temp_files = 0                        # Log all temp files
log_autovacuum_min_duration = 1000        # Log autovacuum > 1s

# ===========================================
# NETWORK AND SECURITY
# ===========================================
listen_addresses = '*'
port = 5432
max_prepared_transactions = 0             # Disable prepared transactions
ssl = off                                 # Disable SSL for performance
lc_messages = 'en_US.UTF-8'
lc_monetary = 'en_US.UTF-8'
lc_numeric = 'en_US.UTF-8'
lc_time = 'en_US.UTF-8'
default_text_search_config = 'pg_catalog.english'
timezone = UTC
log_timezone = UTC

# ===========================================
# STATISTICS AND MONITORING (Minimal)
# ===========================================
default_statistics_target = 50            # Reduced for write performance
constraint_exclusion = partition
cursor_tuple_fraction = 0.1
deadlock_timeout = 1s
lock_timeout = 0                          # No lock timeout for writes

# ===========================================
# QUERY PLANNER SETTINGS (Write-Optimized)
# ===========================================
enable_bitmapscan = on
enable_hashagg = on
enable_hashjoin = on
enable_indexscan = on
enable_indexonlyscan = on
enable_material = on
enable_mergejoin = on
enable_nestloop = on
enable_seqscan = on
enable_sort = on
enable_tidscan = on

# ===========================================
# WRITE-SPECIFIC OPTIMIZATIONS
# ===========================================
# Disable read-heavy features
track_activities = off                    # Disable activity tracking
track_counts = off                        # Disable count tracking
track_io_timing = off                     # Disable I/O timing
track_functions = none                    # Disable function tracking

# Optimize for bulk inserts
max_parallel_workers_per_gather = 0       # Disable parallel workers for writes
max_parallel_workers = 0                  # Disable parallel workers
max_parallel_maintenance_workers = 0      # Disable parallel maintenance 