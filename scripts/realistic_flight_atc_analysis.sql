-- Realistic Flight ATC Frequency Analysis
-- This approach works with actual flight data structure, not artificial time buckets

-- Clean up any existing test data
DELETE FROM flight_sector_occupancy WHERE callsign = 'ABC123';
DELETE FROM transceivers WHERE callsign = 'ABC123';
DELETE FROM transceivers WHERE callsign LIKE 'ATC_ABC%';

-- Create realistic flight data that matches actual VATSIM patterns
-- Flight ABC123 flies through 2 sectors with realistic transceiver data

-- Insert sector data for ABC123 (realistic durations)
INSERT INTO flight_sector_occupancy (callsign, sector_name, entry_timestamp, exit_timestamp, duration_seconds, entry_lat, entry_lon)
VALUES 
('ABC123', 'SECT_X', '2025-01-27 10:00:00+00', '2025-01-27 10:20:00+00', 1200, -33.8688, 151.2093),
('ABC123', 'SECT_Y', '2025-01-27 10:20:00+00', '2025-01-27 10:35:00+00', 900, -33.8688, 151.2093);

-- Insert realistic flight transceiver data (every ~20 seconds like real flights)
INSERT INTO transceivers (callsign, transceiver_id, frequency, entity_type, timestamp, position_lat, position_lon)
VALUES 
-- Sector X: 20 minutes with realistic polling intervals
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:00:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:00:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:00:40+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:01:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:01:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:01:40+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:02:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:02:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:02:40+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:03:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:03:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:03:40+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:04:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:04:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:04:40+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:05:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:05:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:05:40+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:06:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:06:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:06:40+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:07:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:07:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:07:40+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:08:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:08:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:08:40+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:09:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:09:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:09:40+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:10:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:10:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:10:40+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:11:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:11:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:11:40+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:12:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:12:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:12:40+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:13:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:13:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:13:40+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:14:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:14:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:14:40+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:15:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:15:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:15:40+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:16:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:16:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:16:40+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:17:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:17:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:17:40+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:18:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:18:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:18:40+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:19:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:19:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:19:40+00', -33.8688, 151.2093),

-- Sector Y: 15 minutes with realistic polling intervals
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:20:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:20:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:20:40+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:21:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:21:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:21:40+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:22:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:22:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:22:40+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:23:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:23:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:23:40+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:24:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:24:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:24:40+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:25:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:25:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:25:40+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:26:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:26:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:26:40+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:27:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:27:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:27:40+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:28:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:28:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:28:40+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:29:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:29:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:29:40+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:30:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:30:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:30:40+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:31:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:31:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:31:40+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:32:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:32:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:32:40+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:33:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:33:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:33:40+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:34:00+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:34:20+00', -33.8688, 151.2093),
('ABC123', 1, 118500000, 'flight', '2025-01-27 10:34:40+00', -33.8688, 151.2093);

-- Insert ATC data with realistic patterns
INSERT INTO transceivers (callsign, transceiver_id, frequency, entity_type, timestamp, position_lat, position_lon)
VALUES 
-- Sector X: ATC from 10:05-10:15 (10 minutes = 50% of sector time)
('ATC_ABC_X', 1, 118500000, 'atc', '2025-01-27 10:05:00+00', -33.8688, 151.2093),
('ATC_ABC_X', 1, 118500000, 'atc', '2025-01-27 10:05:20+00', -33.8688, 151.2093),
('ATC_ABC_X', 1, 118500000, 'atc', '2025-01-27 10:05:40+00', -33.8688, 151.2093),
('ATC_ABC_X', 1, 118500000, 'atc', '2025-01-27 10:06:00+00', -33.8688, 151.2093),
('ATC_ABC_X', 1, 118500000, 'atc', '2025-01-27 10:06:20+00', -33.8688, 151.2093),
('ATC_ABC_X', 1, 118500000, 'atc', '2025-01-27 10:06:40+00', -33.8688, 151.2093),
('ATC_ABC_X', 1, 118500000, 'atc', '2025-01-27 10:07:00+00', -33.8688, 151.2093),
('ATC_ABC_X', 1, 118500000, 'atc', '2025-01-27 10:07:20+00', -33.8688, 151.2093),
('ATC_ABC_X', 1, 118500000, 'atc', '2025-01-27 10:07:40+00', -33.8688, 151.2093),
('ATC_ABC_X', 1, 118500000, 'atc', '2025-01-27 10:08:00+00', -33.8688, 151.2093),
('ATC_ABC_X', 1, 118500000, 'atc', '2025-01-27 10:08:20+00', -33.8688, 151.2093),
('ATC_ABC_X', 1, 118500000, 'atc', '2025-01-27 10:08:40+00', -33.8688, 151.2093),
('ATC_ABC_X', 1, 118500000, 'atc', '2025-01-27 10:09:00+00', -33.8688, 151.2093),
('ATC_ABC_X', 1, 118500000, 'atc', '2025-01-27 10:09:20+00', -33.8688, 151.2093),
('ATC_ABC_X', 1, 118500000, 'atc', '2025-01-27 10:09:40+00', -33.8688, 151.2093),
('ATC_ABC_X', 1, 118500000, 'atc', '2025-01-27 10:10:00+00', -33.8688, 151.2093),
('ATC_ABC_X', 1, 118500000, 'atc', '2025-01-27 10:10:20+00', -33.8688, 151.2093),
('ATC_ABC_X', 1, 118500000, 'atc', '2025-01-27 10:10:40+00', -33.8688, 151.2093),
('ATC_ABC_X', 1, 118500000, 'atc', '2025-01-27 10:11:00+00', -33.8688, 151.2093),
('ATC_ABC_X', 1, 118500000, 'atc', '2025-01-27 10:11:20+00', -33.8688, 151.2093),
('ATC_ABC_X', 1, 118500000, 'atc', '2025-01-27 10:11:40+00', -33.8688, 151.2093),
('ATC_ABC_X', 1, 118500000, 'atc', '2025-01-27 10:12:00+00', -33.8688, 151.2093),
('ATC_ABC_X', 1, 118500000, 'atc', '2025-01-27 10:12:20+00', -33.8688, 151.2093),
('ATC_ABC_X', 1, 118500000, 'atc', '2025-01-27 10:12:40+00', -33.8688, 151.2093),
('ATC_ABC_X', 1, 118500000, 'atc', '2025-01-27 10:13:00+00', -33.8688, 151.2093),
('ATC_ABC_X', 1, 118500000, 'atc', '2025-01-27 10:13:20+00', -33.8688, 151.2093),
('ATC_ABC_X', 1, 118500000, 'atc', '2025-01-27 10:13:40+00', -33.8688, 151.2093),
('ATC_ABC_X', 1, 118500000, 'atc', '2025-01-27 10:14:00+00', -33.8688, 151.2093),
('ATC_ABC_X', 1, 118500000, 'atc', '2025-01-27 10:14:20+00', -33.8688, 151.2093),
('ATC_ABC_X', 1, 118500000, 'atc', '2025-01-27 10:14:40+00', -33.8688, 151.2093),

-- Sector Y: ATC from 10:25-10:30 (5 minutes = 33.33% of sector time)
('ATC_ABC_Y', 1, 118500000, 'atc', '2025-01-27 10:25:00+00', -33.8688, 151.2093),
('ATC_ABC_Y', 1, 118500000, 'atc', '2025-01-27 10:25:20+00', -33.8688, 151.2093),
('ATC_ABC_Y', 1, 118500000, 'atc', '2025-01-27 10:25:40+00', -33.8688, 151.2093),
('ATC_ABC_Y', 1, 118500000, 'atc', '2025-01-27 10:26:00+00', -33.8688, 151.2093),
('ATC_ABC_Y', 1, 118500000, 'atc', '2025-01-27 10:26:20+00', -33.8688, 151.2093),
('ATC_ABC_Y', 1, 118500000, 'atc', '2025-01-27 10:26:40+00', -33.8688, 151.2093),
('ATC_ABC_Y', 1, 118500000, 'atc', '2025-01-27 10:27:00+00', -33.8688, 151.2093),
('ATC_ABC_Y', 1, 118500000, 'atc', '2025-01-27 10:27:20+00', -33.8688, 151.2093),
('ATC_ABC_Y', 1, 118500000, 'atc', '2025-01-27 10:27:40+00', -33.8688, 151.2093),
('ATC_ABC_Y', 1, 118500000, 'atc', '2025-01-27 10:28:00+00', -33.8688, 151.2093),
('ATC_ABC_Y', 1, 118500000, 'atc', '2025-01-27 10:28:20+00', -33.8688, 151.2093),
('ATC_ABC_Y', 1, 118500000, 'atc', '2025-01-27 10:28:40+00', -33.8688, 151.2093),
('ATC_ABC_Y', 1, 118500000, 'atc', '2025-01-27 10:29:00+00', -33.8688, 151.2093),
('ATC_ABC_Y', 1, 118500000, 'atc', '2025-01-27 10:29:20+00', -33.8688, 151.2093),
('ATC_ABC_Y', 1, 118500000, 'atc', '2025-01-27 10:29:40+00', -33.8688, 151.2093);

-- Verify our test data
SELECT '=== DATA VERIFICATION ===' as info;
SELECT 'Sector Data' as data_type, COUNT(*) as count FROM flight_sector_occupancy WHERE callsign = 'ABC123'
UNION ALL
SELECT 'Flight Transceivers' as data_type, COUNT(*) as count FROM transceivers WHERE callsign = 'ABC123' AND entity_type = 'flight'
UNION ALL
SELECT 'ATC Transceivers' as data_type, COUNT(*) as count FROM transceivers WHERE callsign LIKE 'ATC_ABC%' AND entity_type = 'atc';

-- Show expected vs actual sector times
SELECT '=== SECTOR TIME VERIFICATION ===' as info;
SELECT 
    sector_name,
    entry_timestamp,
    exit_timestamp,
    duration_seconds,
    ROUND(duration_seconds / 60.0, 1) as expected_minutes,
    EXTRACT(EPOCH FROM (exit_timestamp - entry_timestamp))/60 as calculated_minutes
FROM flight_sector_occupancy 
WHERE callsign = 'ABC123'
ORDER BY sector_name;

-- Now test our REALISTIC analysis logic (no time buckets)
SELECT '=== REALISTIC ATC FREQUENCY ANALYSIS ===' as info;
WITH flight_atc_overlap AS (
    SELECT 
        fso.callsign,
        fso.sector_name,
        fso.entry_timestamp,
        fso.exit_timestamp,
        fso.duration_seconds,
        -- Count how many flight transceivers are in this sector
        COUNT(DISTINCT ft.timestamp) as flight_transceiver_count,
        -- Count how many ATC transceivers overlap with flight transceivers
        COUNT(DISTINCT CASE WHEN atc.callsign IS NOT NULL THEN ft.timestamp END) as atc_overlap_count
    FROM flight_sector_occupancy fso
    LEFT JOIN transceivers ft ON 
        fso.callsign = ft.callsign 
        AND ft.entity_type = 'flight'
        AND ft.timestamp BETWEEN fso.entry_timestamp AND fso.exit_timestamp
    LEFT JOIN transceivers atc ON 
        ft.frequency = atc.frequency
        AND atc.entity_type = 'atc'
        AND atc.timestamp BETWEEN fso.entry_timestamp AND fso.exit_timestamp
    WHERE fso.callsign = 'ABC123'
    GROUP BY fso.callsign, fso.sector_name, fso.entry_timestamp, fso.exit_timestamp, fso.duration_seconds
)

SELECT 
    callsign,
    sector_name,
    ROUND(duration_seconds / 60.0, 1) as sector_duration_minutes,
    flight_transceiver_count as flight_polls_in_sector,
    atc_overlap_count as atc_overlaps_with_flight,
    CASE 
        WHEN flight_transceiver_count > 0 THEN
            ROUND((atc_overlap_count::numeric / flight_transceiver_count::numeric) * 100.0, 2)
        ELSE 0
    END as percentage_atc_coverage
FROM flight_atc_overlap
ORDER BY sector_name;

-- Expected Results Summary:
-- Sector X: 20 min total, 60 flight polls, 30 ATC overlaps = 50%
-- Sector Y: 15 min total, 45 flight polls, 15 ATC overlaps = 33.33%

