<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VATSIM Database Query Tool</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 20px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
        }
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }
        .content {
            padding: 30px;
        }
        .query-section {
            margin-bottom: 30px;
        }
        .query-section h3 {
            color: #2c3e50;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .query-tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .query-tab {
            padding: 10px 20px;
            background: #f8f9fa;
            border: none;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
        }
        .query-tab.active {
            background: #3498db;
            color: white;
        }
        .query-content {
            display: none;
        }
        .query-content.active {
            display: block;
        }
        .sql-editor {
            width: 100%;
            height: 200px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            border: 2px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            resize: vertical;
        }
        .button {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
            transition: background 0.3s;
        }
        .button:hover {
            background: #2980b9;
        }
        .button.secondary {
            background: #95a5a6;
        }
        .button.secondary:hover {
            background: #7f8c8d;
        }
        .results {
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
        }
        .results-table {
            width: 100%;
            border-collapse: collapse;
        }
        .results-table th {
            background: #34495e;
            color: white;
            padding: 12px;
            text-align: left;
        }
        .results-table td {
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        .results-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        .status {
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .predefined-queries {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .query-card {
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }
        .query-card:hover {
            border-color: #3498db;
            background: #e3f2fd;
        }
        .query-card h4 {
            margin: 0 0 10px 0;
            color: #2c3e50;
        }
        .query-card p {
            margin: 0;
            font-size: 14px;
            color: #666;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üóÑÔ∏è VATSIM Database Query Tool</h1>
            <p>Query your VATSIM data collection database with ease</p>
        </div>
        
        <div class="content">
            <!-- Database Stats -->
            <div class="query-section">
                <h3>üìä Database Overview</h3>
                <div class="stats" id="database-stats">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading database statistics...
                    </div>
                </div>
            </div>
            
            <!-- Query Interface -->
            <div class="query-section">
                <h3>üîç Query Database</h3>
                
                <div class="query-tabs">
                    <button class="query-tab active" onclick="showTab('predefined')">Predefined Queries</button>
                    <button class="query-tab" onclick="showTab('custom')">Custom SQL</button>
                    <button class="query-tab" onclick="showTab('history')">Query History</button>
                </div>
                
                <!-- Predefined Queries -->
                <div id="predefined" class="query-content active">
                    <div class="predefined-queries" id="predefined-queries">
                        <!-- Predefined queries will be loaded here -->
                    </div>
                </div>
                
                <!-- Custom SQL -->
                <div id="custom" class="query-content">
                    <textarea id="sql-editor" class="sql-editor" placeholder="Enter your SQL query here...&#10;&#10;Example:&#10;SELECT callsign, facility, position FROM atc_positions WHERE status = 'online' LIMIT 10;"></textarea>
                    <button class="button" onclick="executeCustomQuery()">Execute Query</button>
                    <button class="button secondary" onclick="clearEditor()">Clear</button>
                </div>
                
                <!-- Query History -->
                <div id="history" class="query-content">
                    <div id="query-history">
                        <p>No query history yet. Execute some queries to see them here.</p>
                    </div>
                </div>
            </div>
            
            <!-- Results -->
            <div class="query-section">
                <h3>üìã Query Results</h3>
                <div id="status"></div>
                <div id="results"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let queryHistory = [];
        
        // Predefined queries
        const predefinedQueries = {
            'active_controllers': {
                name: 'Active Controllers',
                description: 'Show all currently online controllers',
                sql: `SELECT callsign, facility, position, status, last_seen, workload_score
FROM atc_positions 
WHERE status = 'online' 
ORDER BY last_seen DESC 
LIMIT 20`
            },
            'recent_flights': {
                name: 'Recent Flights',
                description: 'Show recently updated active flights',
                sql: `SELECT callsign, aircraft_type, departure_airport, arrival_airport, altitude, ground_speed, last_updated
FROM flights 
WHERE status = 'active' 
ORDER BY last_updated DESC 
LIMIT 20`
            },
            'controller_workload': {
                name: 'Controller Workload',
                description: 'Analyze controller workload and flight counts',
                sql: `SELECT 
    c.callsign,
    c.facility,
    c.workload_score,
    COUNT(f.id) as flight_count
FROM atc_positions c
LEFT JOIN flights f ON c.id = f.atc_position_id
WHERE c.status = 'online'
GROUP BY c.id
ORDER BY c.workload_score DESC
LIMIT 15`
            },
            'aircraft_types': {
                name: 'Aircraft Types',
                description: 'Distribution of aircraft types in the system',
                sql: `SELECT 
    aircraft_type,
    COUNT(*) as count
FROM flights 
WHERE aircraft_type IS NOT NULL
GROUP BY aircraft_type 
ORDER BY count DESC 
LIMIT 10`
            },
            'facility_stats': {
                name: 'Facility Statistics',
                description: 'Controller count and workload by facility',
                sql: `SELECT 
    facility,
    COUNT(*) as controller_count,
    AVG(workload_score) as avg_workload
FROM atc_positions 
WHERE status = 'online'
GROUP BY facility 
ORDER BY controller_count DESC`
            },
            'recent_activity': {
                name: 'Recent Activity',
                description: 'Activity in the last hour',
                sql: `SELECT 
    'atc_positions' as table_name,
    COUNT(*) as count,
    MAX(last_seen) as latest_update
FROM atc_positions 
WHERE last_seen > datetime('now', '-1 hour')
UNION ALL
SELECT 
    'flights' as table_name,
    COUNT(*) as count,
    MAX(last_updated) as latest_update
FROM flights 
WHERE last_updated > datetime('now', '-1 hour')`
            },
            'traffic_movements': {
                name: 'Traffic Movements',
                description: 'Recent airport traffic movements',
                sql: `SELECT airport_code, movement_type, aircraft_callsign, timestamp
FROM traffic_movements 
ORDER BY timestamp DESC 
LIMIT 20`
            },
            'database_stats': {
                name: 'Database Statistics',
                description: 'Overview of all tables and record counts',
                sql: `SELECT 
    'atc_positions' as table_name,
    COUNT(*) as total_records,
    MAX(last_seen) as latest_data
FROM atc_positions
UNION ALL
SELECT 
    'flights' as table_name,
    COUNT(*) as total_records,
    MAX(last_updated) as latest_data
FROM flights
UNION ALL
SELECT 
    'traffic_movements' as table_name,
    COUNT(*) as total_records,
    MAX(timestamp) as latest_data
FROM traffic_movements`
            }
        };
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            loadDatabaseStats();
            loadPredefinedQueries();
        });
        
        function showTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.query-content').forEach(content => {
                content.classList.remove('active');
            });
            document.querySelectorAll('.query-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }
        
        async function loadDatabaseStats() {
            try {
                const [statusResponse, tablesResponse] = await Promise.all([
                    fetch(`${API_BASE}/api/database/status`),
                    fetch(`${API_BASE}/api/database/tables`)
                ]);
                
                const statusData = await statusResponse.json();
                const tablesData = await tablesResponse.json();
                
                const statsContainer = document.getElementById('database-stats');
                
                // Calculate total records from tables
                const totalRecords = tablesData.tables.reduce((sum, table) => sum + table.record_count, 0);
                
                statsContainer.innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">${tablesData.total_tables}</div>
                        <div class="stat-label">Tables</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${totalRecords.toLocaleString()}</div>
                        <div class="stat-label">Total Records</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${statusData.database.database_type}</div>
                        <div class="stat-label">Database Type</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">${statusData.cache.hits + statusData.cache.misses}</div>
                        <div class="stat-label">Cache Operations</div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading database stats:', error);
                document.getElementById('database-stats').innerHTML = `
                    <div class="stat-card">
                        <div class="stat-number">‚ùå</div>
                        <div class="stat-label">Database Unavailable</div>
                    </div>
                `;
            }
        }
        
        function loadPredefinedQueries() {
            const container = document.getElementById('predefined-queries');
            container.innerHTML = '';
            
            Object.entries(predefinedQueries).forEach(([key, query]) => {
                const card = document.createElement('div');
                card.className = 'query-card';
                card.onclick = () => executePredefinedQuery(key);
                card.innerHTML = `
                    <h4>${query.name}</h4>
                    <p>${query.description}</p>
                `;
                container.appendChild(card);
            });
        }
        
        async function executePredefinedQuery(queryKey) {
            const query = predefinedQueries[queryKey];
            if (!query) return;
            
            document.getElementById('sql-editor').value = query.sql;
            await executeCustomQuery();
        }
        
        async function executeCustomQuery() {
            const sql = document.getElementById('sql-editor').value.trim();
            if (!sql) {
                showStatus('Please enter a SQL query', 'error');
                return;
            }
            
            showStatus('Executing query...', 'info');
            
            // Add to history
            addToHistory(sql);
            
            try {
                const response = await fetch(`${API_BASE}/api/database/query`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ query: sql })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showStatus(`Query executed successfully! Found ${result.row_count} rows.`, 'success');
                    showRealResults(result);
                } else {
                    showStatus(`Query failed: ${result.error}`, 'error');
                }
            } catch (error) {
                showStatus(`Error executing query: ${error.message}`, 'error');
            }
        }
        
        function showRealResults(result) {
            const resultsContainer = document.getElementById('results');
            
            if (!result.data || result.data.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="results">
                        <div style="padding: 20px; text-align: center; color: #666;">
                            No results found for this query.
                        </div>
                    </div>
                `;
                return;
            }
            
            // Get headers from first row
            const headers = result.columns || Object.keys(result.data[0]);
            
            // Prepare data for table
            const tableData = result.data.map(row => {
                return headers.map(header => {
                    const value = row[header];
                    return value !== null && value !== undefined ? String(value) : '';
                });
            });
            
            let tableHTML = `
                <div class="results">
                    <div style="padding: 10px; background: #f8f9fa; border-bottom: 1px solid #ddd;">
                        <strong>Query:</strong> ${result.query}<br>
                        <strong>Rows:</strong> ${result.row_count} | 
                        <strong>Columns:</strong> ${headers.length} |
                        <strong>Time:</strong> ${result.timestamp}
                    </div>
                    <table class="results-table">
                        <thead>
                            <tr>
                                ${headers.map(h => `<th>${h}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${tableData.map(row => `
                                <tr>
                                    ${row.map(cell => `<td>${cell}</td>`).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            resultsContainer.innerHTML = tableHTML;
        }
        
        function clearEditor() {
            document.getElementById('sql-editor').value = '';
        }
        
        function addToHistory(sql) {
            queryHistory.unshift({
                sql: sql,
                timestamp: new Date().toLocaleString()
            });
            
            // Keep only last 10 queries
            if (queryHistory.length > 10) {
                queryHistory = queryHistory.slice(0, 10);
            }
            
            updateHistoryDisplay();
        }
        
        function updateHistoryDisplay() {
            const container = document.getElementById('query-history');
            
            if (queryHistory.length === 0) {
                container.innerHTML = '<p>No query history yet. Execute some queries to see them here.</p>';
                return;
            }
            
            let historyHTML = '<h4>Recent Queries:</h4>';
            queryHistory.forEach((query, index) => {
                historyHTML += `
                    <div class="query-card" onclick="loadQueryFromHistory(${index})">
                        <h4>Query ${index + 1}</h4>
                        <p><strong>Time:</strong> ${query.timestamp}</p>
                        <p><strong>SQL:</strong> ${query.sql.substring(0, 100)}${query.sql.length > 100 ? '...' : ''}</p>
                    </div>
                `;
            });
            
            container.innerHTML = historyHTML;
        }
        
        function loadQueryFromHistory(index) {
            if (queryHistory[index]) {
                document.getElementById('sql-editor').value = queryHistory[index].sql;
                showTab('custom');
            }
        }
        
        function showStatus(message, type) {
            const statusContainer = document.getElementById('status');
            statusContainer.innerHTML = `<div class="status ${type}">${message}</div>`;
            
            // Clear status after 5 seconds
            setTimeout(() => {
                statusContainer.innerHTML = '';
            }, 5000);
        }
    </script>
</body>
</html> 